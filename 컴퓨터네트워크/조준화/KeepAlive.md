# Keep Alive

## 1. TCP Keepalive

- 꺼진 연결 확인 및 유지 메커니즘

TCP Keepalive는 이미 연결된 TCP 세션이 유효한지 확인하고, 좀비 커넥션과 같은 비정상적으로 종료된 연결을 정리하기 위해 주기적으로 작은 크기의 패킷을 보내는 운영체제 커널 레벨의 기능이다.

### 동작 방식

TCP 연결이 수립된 후, 양쪽 통신 장치 간에 아무런 데이터도 전송되지 않는 유휴(Idle) 상태가 일정 시간 지속되면 Keepalive기능이 동작하기 시작한다.

1. 유휴 시간 타이머: 데이터 송수신이 마지막으로 이루어진 시점부터 타이머가 시작된다. tcp_keepalive_time에 도달할 때까지 아무런 데이터 교환이 없으면,
2. Keepalive Probe 전송: 연결을 확인하려는 쪽에서 상대방에게 작은 크기의 Keepalive 프로브 패킷을 보낸다.
3. 응답 확인:
   - 정상 응답: 상대방으로부터 정상적인 ACK 패킷을 받으면, 연결이 여전히 유효하다고 판단하고 다시 유휴 시간 타이머를 초기화한다.
   - 무응답: 상대방에게서 응답이 없으면, tcp_keepalive_intvl을 두고 정해진 횟수(tcp_keepalive_probes)만큼 프로브 패킷을 재전송한다.
4. 연결 종료: 정해진 횟수만큼 프로브를 보냈음에도 계속 응답이 없으면, 상대방과의 연결이 끊어진 것으로 간주하고 RST 패킷을 전송하여 TCP 연결을 종료한다.

### 장단점

장점

1. 좀비 커넥션 방지
2. 네트워크 장애 감지
3. 안정적인 연결 유지

단점

1. 불필요한 트래픽
2. 짧은 타임아웃의 위험 : keepalive_time을 너무 짧게 설정하면 일시적 네트워크 지원에도 연결을 끊어버릴 수 있음.

---

## 2. HTTP Keep-Alive

HTTP Keep-Alive는 한 번 맺은 TCP 연결을 재사용하는 기술이다. HTTP Keep Alive를 통해 웹 브라우저가 웹 페이지에 포함된 여러 파일을 요청할 때마다 새로운 TCP 연결을 맺지 않게 할 수 있다.

자세한 과정은 다음과 같다.

1. 첫 번째 요청: 클라이언트가 `Connection: Keep-Alive` 헤더를 포함하여 Keep-Alive를 사용하도록 설정한다.
2. 연결 유지: 서버가 Keep-Alive를 지원하면, 응답 시 `Connection: Keep-Alive` 헤더를 포함하여 응답한다. 이후 이 TCP 연결은 바로 닫히지 않고 열린 상태로 유지된다.
3. 추가 요청: 클라이언트는 동일한 연결을 통해 다른 파일을 즉시 요청할 수 있다.
4. 연결 종료: 모든 요청-응답이 끝나거나, 미리 설정된 시간 동안 추가 요청이 없으면 연결이 종료된다.

이 방식 덕분에 TCP 연결 설정에 드는 시간을 절약하여 웹 페이지 로딩 속도가 빨라집니다. 🚀

### 주요 헤더 및 설정

HTTP Keep-Alive는 주로 다음과 같은 HTTP 헤더를 통해 제어된다.

- **`Connection: Keep-Alive`**: 클라이언트와 서버가 Keep-Alive 연결을 사용하겠다는 설정이다.
- **`Keep-Alive`**: 연결을 얼마나 유지할지에 대한 세부 설정
  - `timeout`: 연결을 유지할 최대 시간(초)
  - `max`: 해당 연결을 통해 처리할 수 있는 최대 요청 개수
- `Keep-Alive: timeout=5, max=100`
  - 이 연결은 5초 동안 유휴 상태이면 닫히며, 최대 100개의 요청까지 처리할 수 있음을 의미한다.

---

## 3. TCP Keepalive와의 차이점

HTTP Keep-Alive와 TCP Keepalive는 이름은 비슷하지만 완전히 다른 계층에서 다른 목적으로 동작합니다.

| 구분          | **HTTP Keep-Alive**                      | **TCP Keepalive**                          |
| ------------- | ---------------------------------------- | ------------------------------------------ |
| **동작 계층** | 애플리케이션 계층 (Layer 7)              | 전송 계층 (Layer 4)                        |
| **주요 목적** | TCP 연결 **재사용**을 통한 **성능 향상** | 유휴 연결의 **생존 여부 확인** 및 **정리** |
| **제어 주체** | 웹 서버, 웹 브라우저 등 애플리케이션     | 운영체제 (OS) 커널                         |
