# 로드밸런서

## 1. 로드밸런서의 필요성

- **가용성 보장 (High Availability)**: 여러 대의 서버 중 일부에 장애가 발생하더라도, 로드밸런서가 정상적으로 작동하는 다른 서버로 요청을 보내 서비스가 중단되지 않도록 한다.
- **확장성 향상 (Scalability)**: 사용자가 갑자기 늘어나거나 처리해야 할 작업량이 많아져도, 간단하게 서버를 추가하여 대응할 수 있다. 로드밸런서가 새로 추가된 서버에 요청을 자동으로 분배해주므로, 전체 시스템의 처리 능력을 유연하게 확장할 수 있다.
- **성능 및 응답 속도 최적화 (Performance Optimization)**: 로드밸런서는 각 서버의 부하 상태를 고려하여 가장 효율적으로 요청을 처리할 수 있는 서버에 작업을 할당한다.

---

## 2. 로드밸런싱 알고리즘

- **라운드 로빈 (Round Robin)**: 가장 기본적인 방식. 요청이 들어오는 순서대로 각 서버에 균등하게 요청을 분배한다.
- **가중 라운드 로빈 (Weighted Round Robin)**: 각 서버의 처리 성능이 다른 경우, 성능이 좋은 서버에 더 많은 요청을 할당하는 방식이다.
- **최소 연결 (Least Connection)**: 현재 연결 수가 가장 적은 서버에 요청을 보내는 방식이다.
- **IP 해시 (IP Hash)**: 클라이언트의 IP 주소를 해싱하여 특정 서버에만 요청을 보내는 방식이다. 이 방식을 사용하면, 특정 클라이언트는 항상 같은 서버에 접속하게 되므로, 로그인 정보나 장바구니 같은 세션 정보를 해당 서버에서 계속 유지해야 하는 서비스에 유용하다.
- **최소 응답 시간 (Least Response Time)**: 서버의 응답 시간을 주기적으로 확인하여, 가장 빠른 응답 시간을 보이는 서버에 요청을 우선적으로 보내는 방식이다.

---

## 3. 여러 가지 로드 밸런싱 기술들

### AWS의 로드 밸런서: Elastic Load Balancing (ELB)

ELB는 들어오는 애플리케이션 트래픽을 여러 대상(예: EC2 인스턴스, 컨테이너, IP 주소)에 자동으로 분산시켜 준다.

- **Application Load Balancer (ALB)**: HTTP 및 HTTPS 트래픽에 최적화된 로드 밸런서이다. URL 경로 기반 라우팅 등 고급 기능을 제공하여, `/images` 경로는 이미지 서버 그룹으로, `/videos` 경로는 비디오 서버 그룹으로 보내는 등 지능적인 분배가 가능하다.
- **Network Load Balancer (NLB)**: TCP 및 UDP 트래픽 처리에 특화되어 있으며, 엄청난 양의 트래픽을 매우 짧은 지연 시간으로 처리할 수 있다.

서버를 여러 대 띄운다고 해서 처음부터 모두 똑같이 동작하지는 않는다. 각 서버에 동일한 운영체제, 소프트웨어, 설정, 코드가 설치되어 있어야 하며 이를 관리하기 위한 방법으로는 AWS의 **AMI (Amazon Machine Image)** 와 **Auto Scaling Group**이 있다.

Auto Scaling 과정은 다음과 같다.

1. **기준 서버 만들기**: 먼저 EC2 인스턴스를 하나 생성하고 필요한 웹 서버, 데이터베이스 등의 소프트웨어를 설치, 배포한다.
2. **AMI 생성**: 구성된 서버를 바탕으로 **AMI(Amazon Machine Image)** 라는 '서버 복제용 틀'을 만든다. 마치 스냅샷과 같다.
3. **Auto Scaling Group 설정**: 그리고 Auto Scaling Group을 설정하여 서버를 자동으로 생성하고 관리하게끔 설정하면 된다.

정리하자면 ELB는 미리 지정된 서버들에게 트래픽을 분배하는 역할이다. Auto Scaling Group은 정해진 규칙에 따라 서버를 자동으로 생성하거나 삭제한다.

### NginX

NginX는 서버를 Passive 방식으로 검사한다. ELB처럼 계속해서 상태 검사용 요청을 보내는 것이 아닌, 실제 사용자 요청이 실패하면 해당 서버에 문제가 있다고 판단하는 방식이다.

아래와 같은 설정이 있을 때 NignX가 요청을 처리하는 과정을 보자.

```json
upstream my_servers {
    server 192.168.1.10 max_fails=3 fail_timeout=30s;
    server 192.168.1.11;
    server 192.168.1.12;
}
```

1. **정상 상태**: Nginx는 기본적으로 라운드 로빈 방식으로 10번, 11번, 12번 서버에 요청을 순서대로 보낸다.
2. **장애 감지**: 만약 10번 서버에 요청을 보냈는데, 응답이 없거나 에러가 발생하면 Nginx는 이것을 '실패 1회'로 기록한다. 이 과정이 **`max_fails=3`** 에 설정된 3번 누적될 때까지 반복된다.
3. **장애 서버 제외**: '문제가 있다'고 판단된 10번 서버를 **`fail_timeout=30s`** 에 설정된 30초 동안 로드 밸런싱 대상에서 자동으로 제외한다.
4. **상태 복구 확인**: 30초가 지나면 Nginx는 10번 서버가 복구되었는지 확인하기 위해 다음 요청을 다시 보내는 방식이다.
