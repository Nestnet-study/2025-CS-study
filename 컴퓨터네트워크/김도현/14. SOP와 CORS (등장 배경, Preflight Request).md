## SOP (Same-Origin Policy)

### 정의와 기본 개념

**Same-Origin Policy(동일 출처 정책)**는 웹 브라우저의 기본 보안 정책으로, **같은 출처(origin)에서만 리소스에 접근을 허용**하는 정책입니다.

**출처(Origin)**는 **프로토콜 + 호스트 + 포트**로 구성됩니다:

- 같은 출처: `https://example.com:443/page1`, `https://example.com:443/api/data`
- 다른 출처: `http://example.com` (프로토콜), `https://sub.example.com` (호스트), `https://example.com:8080` (포트)

### 등장 배경

- **보안 위협 방지**: 악성 사이트가 사용자가 로그인한 다른 사이트 정보를 탈취하는 것을 차단
- **사용자 프라이버시 보호**: 쿠키 및 인증 정보 보호, 개인 데이터 유출 방지
- **CSRF 공격 방지**: 크로스 사이트 요청 위조 공격 차단

### SOP가 제한하는 것들

- **XMLHttpRequest/Fetch API**: 다른 출처로의 AJAX 요청 차단
- **DOM 접근**: iframe으로 로드된 다른 출처 페이지의 DOM 접근 차단
- **로컬 스토리지**: 각 출처별로 독립적인 저장소 유지

### 예외 사항

- **HTML 태그들**: `<img>`, `<script>`, `<link>`, `<iframe>` 등은 다른 출처 리소스 로드 가능
- **document.domain**: 서브도메인 간 통신 허용 가능

---

## CORS (Cross-Origin Resource Sharing)

### 정의와 기본 개념

**Cross-Origin Resource Sharing**는 **SOP의 제한을 완화하여 다른 출처 간 리소스 공유를 안전하게 허용**하는 W3C 표준입니다.

### 등장 배경

- **웹 애플리케이션의 복잡화**: 프론트엔드와 백엔드 API 서버가 다른 출처를 사용하는 경우 증가
- **마이크로서비스 아키텍처**: 서비스별로 다른 도메인/포트 사용 필요
- **Third-party API 사용 증가**: 외부 API 서비스 활용 필요성 증대

### CORS 동작 방식

#### 1. 단순 요청 (Simple Request)

**조건**: GET/HEAD/POST 메서드, 특정 헤더만 사용, 사용자 정의 헤더 없음

- 서버 응답에 `Access-Control-Allow-Origin` 헤더가 포함되어야 함

#### 2. 프리플라이트 요청 (Preflight Request)

**조건**: 단순 요청 조건을 만족하지 않는 복잡한 요청

- 실제 요청 전에 OPTIONS 메서드로 사전 확인
- 서버가 해당 요청을 허용하는지 미리 검증

---

## Preflight Request 상세

### 프리플라이트가 필요한 경우

- **HTTP 메서드**: PUT, DELETE, PATCH 등
- **Content-Type**: application/json 등
- **사용자 정의 헤더**: Authorization, X-Requested-With 등

### 동작 과정

1. **OPTIONS 요청**: 브라우저가 자동으로 사전 확인 요청 전송
2. **서버 응답**: 허용되는 메서드, 헤더, 출처 등을 응답 헤더에 포함
3. **실제 요청**: 프리플라이트 성공 시에만 실제 요청 전송

### 최적화 방법

- **Access-Control-Max-Age**: 프리플라이트 결과 캐싱으로 반복 요청 방지
- **단순 요청으로 설계**: 가능한 경우 복잡한 요청 대신 단순 요청 사용

---

## SOP와 CORS 비교

### 공통점

- **보안 목적**: 둘 다 웹 보안을 위한 정책
- **브라우저 구현**: 브라우저에서 자동으로 적용
- **출처 기반**: Origin(출처) 개념을 기반으로 동작
- **사용자 투명**: 백그라운드에서 자동 동작

### 차이점

|구분|SOP|CORS|
|---|---|---|
|**목적**|다른 출처 접근을 차단|안전한 다른 출처 접근을 허용|
|**기본 동작**|모든 크로스 오리진 요청 차단|서버 허가 시 크로스 오리진 요청 허용|
|**설정 주체**|브라우저 (자동)|서버 개발자 (수동)|
|**유연성**|엄격함|유연함 (서버가 제어)|

### 관계

- **SOP**: 기본적으로 모든 크로스 오리진 요청을 차단하는 보안 정책
- **CORS**: SOP의 예외로, 서버가 명시적으로 허용한 크로스 오리진 요청만 통과

---

## 핵심 정리

### SOP (Same-Origin Policy)

- **웹 브라우저의 기본 보안 정책**
- **같은 출처에서만 리소스 접근 허용**
- **악성 사이트로부터 사용자 보호**

### CORS (Cross-Origin Resource Sharing)

- **SOP의 안전한 우회 방법**
- **서버가 허용한 다른 출처 접근만 허용**
- **현대 웹 개발의 필수 기술**

### 중요 포인트

1. **SOP는 기본 차단, CORS는 예외 허용**
2. **복잡한 요청에는 Preflight 과정 필요**
3. **서버 측에서 적절한 CORS 헤더 설정 필수**
4. **보안과 편의성의 균형이 중요**