## 프로세스

프로그램 실행(프로세스)은 디스크의 명령어가 메모리에 올라와 CPU로 연산된 후 다시 메모리와 디스크에 저장되는 과정이다. 디스크 → 메모리 → CPU → 메모리 → 디스크로 명령어와 데이터가 이동하며 수행된다.

![](https://i.imgur.com/nDhrBlE.png)


프로그램은 실행 전에는 디스크에 저장된 0,1의 집합체일 뿐이며, 메모리에 적재되고 CPU의 제어장치에서 해석(decode)될 때 비로소 의미를 가지고 동작을 수행한다. 프로그램 실행 시 우선 메모리를 할당하는 로드 과정이 필요하다.

### 프로세스 메모리 로드

아래와 같은 흐름으로 진행된다:

**1) 프로그램 코드와 정적 데이터(static data)를 메모리에 적재한다.**

- 모든 코드와 데이터를 한번에 로드하지 않고 중요한 일부만 먼저 로드함 (dynamic loading)
- 모든 코드를 한번에a 로드할 경우 boot strap 시간이 많이 소요됨

**2) 해당 프로그램이 사용할 스택 공간을 메모리에 마련한다.**

- 지역변수, 함수 인자, 리턴 주소 등을 저장하는 용도

**3) 프로그램의 힙(heap) 메모리 영역도 할당한다.**

**4) 해당 프로그램의 입출력을 위한 파일 디스크립터(file descriptor)도 생성한다.**

**5) 프로그램 시작점(main() 함수)부터 프로그램 코드의 명령어를 CPU의 레지스터로 올리고 연산하는 작업흐름을 시작한다.**

메모리는 여러 개의 섹션으로 나뉘어 있다:

- **text section**: 기계어로 번역된 명령어들이 올라옴
- **data section**: 전역변수, 정적 변수들이 저장됨
- **BSS section**: 초기화되지 않은 전역변수, 정적 변수들이 저장됨
- **heap section**: 프로그램에서 동적으로 할당하는 메모리 공간 (C의 malloc, 자바의 컬렉션, new 등)
- **stack section**: 함수의 인자, 지역변수, 반환주소 등이 저장됨

![](https://i.imgur.com/FOKvQct.png)


### 프로세스의 상태

프로세스는 효율적인 관리를 위해 상태와 생명주기를 가진다. 프로세스가 I/O 작업을 기다리는지, 다시 로드해 실행 가능한 상태인지 등을 파악함으로써 CPU 스케줄링을 효율적으로 할 수 있다.

프로세스는 다음 상태를 가진다: **NEW / RUNNING / WAITING / READY / TERMINATED**

![](https://i.imgur.com/4xuyjc1.png)


**WAITING**: 디스크 I/O, 마우스/키보드 I/O 등의 이벤트를 기다리는 상태 
**READY**: CPU 할당(RUNNING)을 기다리는 상태로, 스케줄링에 의해 아직 RUNNING되지 않고 있음. 모든 프로세스가 동시에 CPU를 점유할 수 없기 때문에 생기는 상태. READY 상태는 ready queue에 들어가 있음을 의미한다.

프로세스의 상태는 **PCB(process control block)**에 필요한 정보를 저장하여 상태변경 및 문맥교환 시에 활용한다.





## 프로세스, 스레드의 동기화 - 임계영역

프로세스, 스레드들이 데이터를 공유하며 concurrent, 병렬적으로 작업하면 data inconsistency문제가 발생. -> 작업들의 순서를 보장해야 한다.  
ex) producer - consumer 문제에서 일종의 갱신유실(lost update가 발생한다)

이 해결을 위해서 동기화를 해야하는데 이를 위해 **임계영역 (critical section)**을 구현한다.  
임계영역은 entry section, critical section, exit xection, remainder section 으로 나눌 수 있다.

임계영역에 특정 시간에는 임계영역에 특정 실행흐름만 접근하도록 제한하는 식으로  
상호배제를 구현하다보면 해결해야 하는 문제가 있다.  
**deadlock**과 **starvation**이다.

임계영역 문제( deadlock, starvation(기아) )의 해결법들

- 싱글 코어에서의 가장 간단한 방법으로는 임계영역에 들어간 실행흐름이 있는동안은 다른 실행흐름이 들어올 수 없고, 실행흐름이 알아서 반납하도록 만드는 방법이다.(**비선점형 스케줄링**)  
    해당 instruction을 fetch, execute, store하는 동안은 interrupt 불가능하게 하기.  
    하지만 이런 비선점형은 다른 실행흐름이 기다리는 것밖에 할 수 없기 때문에 성능의 개선이 힘들다.

### PCB
![](https://i.imgur.com/Fz7stpX.png)

PCB(Process Control Block)는 운영체제가 프로세스를 관리하기 위해 사용하는 데이터 구조입니다. 각 프로세스마다 하나의 PCB가 할당되며, 프로세스의 모든 중요 정보를 저장합니다.
PCB에 저장되는 주요 정보는 다음과 같습니다:

프로세스 식별자(Process ID): 각 프로세스의 고유한 ID
프로세스 상태: 실행(Running), 준비(Ready), 대기(Waiting) 등의 상태 정보
프로그램 카운터(Program Counter): 다음에 실행할 명령어의 주소를 가리킴
CPU 레지스터: 프로세스가 중단되었을 때 저장해야 할 레지스터 값들
CPU 스케줄링 정보: 우선순위, 스케줄링 큐 포인터 등
메모리 관리 정보: 메모리 경계, 페이지 테이블, 세그먼트 테이블 등
입출력 상태 정보: 프로세스에 할당된 입출력 장치들의 목록, 열린 파일 목록 등
계정 정보: CPU 사용 시간, 시간제한, 프로세스 번호 등

PCB는 프로세스가 CPU를 사용하다가 다른 프로세스에게 CPU를 넘겨줄 때(컨텍스트 스위칭) 현재 상태를 저장하고, 나중에 다시 실행될 때 저장된 상태를 복원하는 데 중요한 역할을 합니다. 운영체제는 이 PCB를 통해 시스템 내의 모든 프로세스를 효율적으로 관리하고 스케줄링할 수 있습니다.



### 피터슨 알고리즘

피터슨 알고리즘은 두 프로세스 간의 상호배제를 보장하는 소프트웨어 기반 솔루션이다. 두 개의 공유 변수(flag 배열과 turn 변수)를 사용한다:

- flag 배열: 프로세스가 임계 영역에 들어가고자 하는 의향을 나타냄
- turn 변수: 현재 누구의 차례인지 표시

각 프로세스는 자신의 flag를 true로 설정하고, turn을 상대방으로 지정한 후, 상대방이 임계 영역에 들어가려는 의향이 없거나 자신의 차례일 때까지 대기한다. 이를 통해 상호배제, 진행, 한정된 대기 조건을 모두 충족한다.

### ### 동기화 툴 - 뮤텍스, 세마포어, 모니터

**뮤텍스(Mutex)**:

- 상호배제(Mutual Exclusion)를 위한 동기화 도구
- 임계 영역에 하나의 스레드만 접근 가능하도록 보장
- 락(lock)을 획득한 스레드만 임계 영역 진입 가능, 작업 완료 후 락을 해제
- 이진 상태(잠금/해제)만 가지며, 소유자 개념이 있어 락을 획득한 스레드만 해제 가능

**세마포어(Semaphore)**:

- 다익스트라가 제안한 동기화 도구로 카운터 개념을 가짐
- 이진 세마포어(Binary Semaphore): 0과 1 두 가지 값만 가지며 뮤텍스와 유사하게 작동
- 카운팅 세마포어(Counting Semaphore): 여러 개의 자원에 대한 접근을 제어할 때 사용
- P(감소) 연산: 세마포어 값을 감소시키고, 값이 0이면 대기
- V(증가) 연산: 세마포어 값을 증가시키고, 대기 중인 프로세스가 있으면 깨움
- 뮤텍스와 달리, 락을 획득한 스레드가 아닌 다른 스레드도 세마포어를 해제 가능

**모니터(Monitor)**:

- 고수준 동기화 매커니즘으로, 공유 자원을 숨기고 인터페이스로만 접근 가능하게 캡슐화
- 모니터 내부의 프로시저(메소드)는 한 번에 하나의 스레드만 실행 가능
- 조건 변수(Condition Variable)를 통해 스레드 간 통신과 동기화 지원
- wait(): 스레드를 대기 상태로 전환하고 모니터 락을 해제
- signal(): 대기 중인 스레드 중 하나를 깨움
- 세마포어보다 사용이 간편하고 오류 발생 가능성이 낮음
- Java의 synchronized 키워드와 wait()/notify() 메소드가 모니터 패턴을 구현한 예




참고: https://velog.io/@ttomy/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%EB%8F%99%EA%B8%B0%ED%99%94