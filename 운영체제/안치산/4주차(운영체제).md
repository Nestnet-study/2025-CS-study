1. 프로세스/스레드/동기화
2. OS가 메모리 다루는 방법

---

### 프로세스/스레드/동기화

- 프로세스
	- 완전히 독립된 메모리공간
- 스레드
	- 프로세스 내부의 실행단위
	- 데이터/힙 영역 공유
	- 스택은 스레드별로 할당
- 동기화 도구들
	- 세마포어
	- 뮤텍스 (이진 세마포어와 비슷)
	- 스핀락
	- 조건변수
	- 모니터: 락 + 조건변수



- java synchronized 동작원리
	- 동시에 하나의 스레드만 해당 코드에 들어갈 수 있도록 제한
		- 모든 객체는 모니터를 가지고 있음
			- 헤더에 모니터 락 정보가 들어있음
			- mark word
		- 스레드가 synchronized 블록에 진입하면
			- 해당 객체의 모니터락 획득
			- 다른 스레드는 락 해제될때까지 blocking
		- 블록 종료시
			- 락을 해제하고
			- 다른 대기 스레드를 깨움
	- 최적화를 위해 락 점유시간에 따라 단계적으로 전환
		1) Biased Locking:
			- 락 없이 객체 헤더에 사용여부 표시
			- 초기 JVM은 싱글 스레드 위주로 동작해서 등장했던 개념
			- 현재는 없어짐
		2) 경량락 (Lightweight Lock):
			- CAS 시도 (락 충돌 없으면 끝)
			- 충돌 시 잠깐 스핀(스핀락처럼)
			- 계속 실패 → 중량락 승격
		3) 중량략:
			- 스레드 blocking

- lock-free programming
	- ex. JAVA ConcurrentHashmap
	- CAS 등의 원자성 연산을 활용해서 성공할때까지 계속 재시도
	- 스핀락과 비슷하지만 락 소유자에 대한 의존성이 없어짐 (락 소유자가 락을 풀때까지 기다리는게 아니라 성공할때까지 재시도하는거라)

- CAS (compare and swap)
	- 하드웨어 레벨에서 비교 및 교체 연산을 한번에 실행함
	- 내가 갖고있는 값과 동일한 경우에만 요청한 값으로 변경
	- (만약 다른 곳에서 먼저 연산을 수행해서 값이 변경되었다면 처리되지않음)

	- 보통 CPU의 명령어 실행 유닛에 의해서 처리됨 (ALU)
	- 하드웨어 레벨의 락을 통해 일관성 보장

- JIT 락 최적화 기법
	- JIT 컴파일러(Graal, C2)는 싱글 스레드 환경에서:  
		- 락이 필요 없는 경우 락을 아예 제거(Elimination) 하거나,
		- 락이 루프 안에 있으면 락 병합(Lock Coarsening) 등으로 최소화함
			- 락 작업량이 많을 경우 오히려 병목이 생길 수 있으므로 이 경우에는 병합하지 않음

- JAVA 가상스레드
	- 가상스레드별 스택을 힙 영역에 저장해서 사용
	- 


---
### OS가 메모리 다루는 방법

- 각 프로세스는 독립된 가상 메모리 공간을 갖고 있고, OS는 이걸 프로세스마다 격리해서 관리
##### 메모리 영역 분할
- 텍스트 영역 (Code Segment): 실행 코드가 올라감
- 데이터 영역 (Data Segment): 초기화된 전역/정적 변수
- BSS 영역: 초기화되지 않은 전역/정적 변수
- 힙 (Heap): 동적 메모리 할당 공간 (malloc 등)
- 스택 (Stack): 함수 호출 시 지역 변수 등
##### 시스템 전체 메모리 관리
- 가상 메모리 관리
	- CPU는 가상 주소(Virtual Address)만 다루고, OS + MMU(Memory Management Unit)가 이를 물리 주소(Physical Address)로 변환
	- 페이지 테이블
		- 가상 페이지 ↔ 물리 페이지를 매핑하는 테이블
	- TLB(Translation Lookaside Buffer)
		- 페이지 테이블에 대한 CPU 내부에 존재하는 캐시
- 메모리 할당 전략
	- 연속 메모리 할당: 예전 방식으로, 프로세스마다 연속된 메모리 블록 할당 (단편화 문제 발생)
	- 페이징: 고정 크기의 페이지로 메모리를 나눔 → 내부 단편화만 발생
	- 세그멘테이션: 가변 크기 세그먼트로 나눔 → 외부 단편화 발생

	- 외부 단편화 문제
	- 내부 단편화 문제

	- 세그멘테이션은 더 이상 사용되지 않음 (구현이 복잡해서 병목이 생기고, 기술의 발달로 메모리 공간을 이전처럼 쥐어짤 필요없음)

- 스왑, 페이지교체
	- 스왑은 특정 프로세스의 전체 공간을 메모리에서 내려버리는거
	- 페이지교체는 페이지 단위로 교체
	- 오늘날에는 스왑은 안 쓰임
	- 스왑공간이라는 용어는 여전히 사용되는데 메모리 공간을 내보내는 용도로 사용되는 디스크 공간을 말함

